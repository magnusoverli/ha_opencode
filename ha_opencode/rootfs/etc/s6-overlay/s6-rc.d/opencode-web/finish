#!/command/with-contenv bashio
# ==============================================================================
# OpenCode Web UI - Finish Script
# Handles service crashes and signals container exit
# ==============================================================================

readonly exit_code_container=$(</run/s6-linux-init-container-results/exitcode)
readonly exit_code_service="${1}"
readonly exit_code_signal="${2}"

bashio::log.info "OpenCode Web UI exited with code ${exit_code_service} (signal ${exit_code_signal})"

# If service was killed by signal
if [[ "${exit_code_service}" -eq 256 ]]; then
  if [[ "${exit_code_container}" -eq 0 ]]; then
    echo $((128 + exit_code_signal)) > /run/s6-linux-init-container-results/exitcode
  fi
  # SIGTERM (15) is normal shutdown, don't halt
  [[ "${exit_code_signal}" -eq 15 ]] && exec /run/s6/basedir/bin/halt
# If service crashed with non-zero exit
elif [[ "${exit_code_service}" -ne 0 ]]; then
  if [[ "${exit_code_container}" -eq 0 ]]; then
    echo "${exit_code_service}" > /run/s6-linux-init-container-results/exitcode
  fi
  bashio::log.error "OpenCode Web UI crashed! Halting container..."
  exec /run/s6/basedir/bin/halt
fi
