#!/command/with-contenv bashio
# ==============================================================================
# HA OpenCode - Initialization Service (oneshot)
# Runs once at container startup to prepare the environment
# ==============================================================================

bashio::log.info "Initializing HA OpenCode..."

# Set up persistent HOME for all services
export HOME="/data"
export XDG_DATA_HOME="/data/.local/share"
export XDG_CONFIG_HOME="/data/.config"

# Ensure data directories exist
mkdir -p /data/.local/share/opencode
mkdir -p /data/.config/opencode

# ==============================================================================
# Deploy AGENTS.md to Home Assistant config directory (first install only)
# Users can customize this file using File Editor or any text editor
# ==============================================================================

if [ ! -f "/homeassistant/AGENTS.md" ]; then
    cp /opt/ha-mcp-server/AGENTS.md /homeassistant/AGENTS.md
    bashio::log.info "Deployed default AGENTS.md to /homeassistant/"
    bashio::log.info "You can customize AI instructions by editing AGENTS.md"
fi

# ==============================================================================
# Deploy Prettier config for HA YAML formatting (first install only)
# Prettier auto-formats YAML files written by OpenCode to follow HA conventions
# Users can customize .prettierrc.yaml to adjust formatting preferences
# ==============================================================================

if [ ! -f "/homeassistant/.prettierrc.yaml" ]; then
    cp /opt/ha-mcp-server/.prettierrc.yaml /homeassistant/.prettierrc.yaml
    bashio::log.info "Deployed default .prettierrc.yaml for HA YAML formatting"
fi

# ==============================================================================
# Read configuration options
# ==============================================================================

MCP_ENABLED=$(bashio::config 'mcp_enabled')
LSP_ENABLED=$(bashio::config 'lsp_enabled' || echo "true")

bashio::log.info "Configuration: MCP=${MCP_ENABLED} LSP=${LSP_ENABLED}"

# ==============================================================================
# Generate OpenCode configuration file
# ==============================================================================

MCP_BOOL=$([ "${MCP_ENABLED}" = "true" ] && echo "true" || echo "false")
LSP_DISABLED=$([ "${LSP_ENABLED}" = "true" ] && echo "false" || echo "true")

jq --argjson mcp "${MCP_BOOL}" --argjson lsp_disabled "${LSP_DISABLED}" '
    .mcp.homeassistant.enabled = $mcp |
    if $lsp_disabled then .lsp["ha-yaml"].disabled = true else del(.lsp["ha-yaml"].disabled) end
' /opt/ha-mcp-server/opencode-ha.json > /data/.config/opencode/opencode.json

bashio::log.info "OpenCode configuration generated successfully"

# ==============================================================================
# Inject custom OpenCode config.json (optional, for advanced users)
# This allows power users to provide custom OpenCode configuration as a JSON
# string via the add-on config UI. It is written to config.json which OpenCode
# merges with opencode.json (our MCP/LSP config) at startup.
# See https://opencode.ai/docs/config for the full schema.
# ==============================================================================

OPTIONS_FILE="/data/options.json"
CONFIG_TARGET="/data/.config/opencode/config.json"

if [ -f "${OPTIONS_FILE}" ]; then
    OPENCODE_CONFIG_JSON=$(jq -r '.opencode_config // empty' "${OPTIONS_FILE}")
    if [ -n "${OPENCODE_CONFIG_JSON}" ]; then
        # Validate that the provided string is valid JSON
        if ! printf '%s' "${OPENCODE_CONFIG_JSON}" | jq -e . >/dev/null 2>&1; then
            bashio::log.error "Invalid JSON in opencode_config option. Skipping custom config."
            bashio::log.error "Please check your JSON syntax in the Configuration tab."
            # Remove stale config.json so a previously valid config doesn't persist
            rm -f "${CONFIG_TARGET}"
        else
            printf '%s' "${OPENCODE_CONFIG_JSON}" > "${CONFIG_TARGET}"
            bashio::log.info "Custom OpenCode config.json written from add-on configuration"
        fi
    else
        # No custom config provided - remove any stale config.json from a previous run
        rm -f "${CONFIG_TARGET}"
    fi
fi
